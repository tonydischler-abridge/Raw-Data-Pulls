WITH
DATE_PARAMS AS (
    SELECT
            CAST('2023-04-01' AS date) AS START_DATE,
            DATEADD(DAY, -1, CAST(GETDATE() AS date)) AS END_DATE
),

date_filtered_enc AS (
    SELECT 
        e.PAT_ENC_CSN_ID, 
        e.CONTACT_DATE
    FROM PAT_ENC e
    CROSS JOIN DATE_PARAMS dp
    WHERE e.CONTACT_DATE >= dp.START_DATE
        AND e.CONTACT_DATE <= dp.END_DATE
        AND e.ENC_TYPE_C IN (3,76,101) -- hospital, telemedicine, and office visit -- update as needed
        AND (e.APPT_STATUS_C IN (2,6) OR e.APPT_STATUS_C IS NULL)
),

AMBIENT_VIA_SDE AS (
    SELECT DISTINCT e.PAT_ENC_CSN_ID
    FROM date_filtered_enc e
    WHERE EXISTS (
        SELECT 1
        FROM SMRTDTA_ELEM_DATA  sde
        INNER JOIN SMRTDTA_ELEM_VALUE sev
            ON sev.HLV_ID = sde.HLV_ID
        WHERE sde.CONTACT_SERIAL_NUM = e.PAT_ENC_CSN_ID
            AND sde.ELEMENT_ID IN (
                'EPIC#31000231848','EPIC#31000231852','EPIC#31000231850','EPIC#31000231851','EPIC#31000231856'
            )
    )
),

AMBIENT_VIA_NAS AS (
    SELECT DISTINCT e.PAT_ENC_CSN_ID
    FROM date_filtered_enc e
    WHERE EXISTS (
        SELECT 1
        FROM HNO_INFO hno
        INNER JOIN NOTE_AMBIENT_SECTIONS nas
            ON nas.NOTE_ID = hno.NOTE_ID
        WHERE hno.PAT_ENC_CSN_ID = e.PAT_ENC_CSN_ID
            AND nas.AMBIENT_SESSION_IDENT IS NOT NULL
    )
),

AMBIENT_VIA_ATTR AS (
    SELECT DISTINCT e.PAT_ENC_CSN_ID
    FROM date_filtered_enc e
    WHERE EXISTS (
        SELECT 1
        FROM HNO_INFO hno
        INNER JOIN NOTE_ATTRIBUTION na
            ON na.NOTE_ID = hno.NOTE_ID
        WHERE hno.PAT_ENC_CSN_ID = e.PAT_ENC_CSN_ID
            AND na.NOTEATTR_SOURCE_C = 25
    )
),

AMBIENT_VIA_DXR AS (
    SELECT DISTINCT e.PAT_ENC_CSN_ID
    FROM date_filtered_enc e
    WHERE EXISTS (
        SELECT 1
        FROM DOCS_RCVD_DETAILS d
        INNER JOIN DOCS_RCVD_NOTE_SECTIONS n
            ON n.DOCUMENT_ID = d.DOCUMENT_ID
        WHERE d.DOCUMENT_RQST_CSN = e.PAT_ENC_CSN_ID
            AND d.DOCUMENT_RQST_CSN IS NOT NULL
    )
),

ALL_AMBIENT AS (
    SELECT PAT_ENC_CSN_ID FROM AMBIENT_VIA_SDE
    UNION
    SELECT PAT_ENC_CSN_ID FROM AMBIENT_VIA_NAS
    UNION
    SELECT PAT_ENC_CSN_ID FROM AMBIENT_VIA_ATTR
    UNION
    SELECT PAT_ENC_CSN_ID FROM AMBIENT_VIA_DXR
)

SELECT 
    arpb.PAT_ENC_CSN_ID,
    penc.LOS_PROC_CODE,
    CASE WHEN arpb.PAT_ENC_CSN_ID IN (SELECT PAT_ENC_CSN_ID FROM ALL_AMBIENT) THEN 'Y' ELSE 'N' END AS AMBIENT_FLAG,
    arpb.TX_ID,
    rvu.CPT_CODE,
    rvu.PROCEDURE_CODE,
    rvu.PROCEDURE_NAME,
    rvu.PROCEDURE_QUANTITY,
    rvu.AMOUNT billed_amount,
    rvu.RVU_WORK,
    arpb.LOC_ID,
    arpb.SERVICE_AREA_ID,
    arpb.PRIMARY_DX_ID,
    arpb.PROV_SPECIALTY_C prov_specialty_code,
    zsp.NAME prov_specialty_name,
    rvu.BILL_AREA_NAME,
    ha.HSP_ACCOUNT_ID,
    ha.HSP_BASECLS_HA_C,
    ha.ACCT_BILLED_DATE,
    ha.ACCT_FIN_CLASS_C,
    ha.ATTENDING_PROV_ID,
    ha.HSP_ADM_DATE_TIME,
    ha.DISCH_DATE_TIME,
    ha.ER_ADMIT_DATE_TIME,
    ha.ER_DSCHG_DATE_TIME,
    ha.FINAL_DRG_ID,
    atcr.NET_COLL_RATIO,
    atcr.ACTUAL_AR_COLLECTIONS,
    atcr.EXPECTED_AR_COLLECTIONS,
    bdc.BDC_NAME,
    bdc.RECORD_TYPE_C AS BDC_RECORD_TYPE,
    bdc.BDC_CREATE_DATE,
    bdc.BDC_COMPLETE_VOID_DATE,
    bdc.DENIAL_CATEGORY_C,
    bdc.IS_INITIAL_DENIAL_YN
FROM ARPB_TRANSACTIONS arpb
INNER JOIN date_filtered_enc dfe
    ON arpb.PAT_ENC_CSN_ID = dfe.PAT_ENC_CSN_ID
LEFT JOIN V_ARPB_RVU_DATA rvu 
    ON arpb.TX_ID = rvu.TRANSACTION_ID
LEFT JOIN V_PAT_ENC penc
    ON arpb.PAT_ENC_CSN_ID = penc.PAT_ENC_CSN_ID
LEFT JOIN ZC_SPECIALTY zsp 
    ON arpb.PROV_SPECIALTY_C = zsp.SPECIALTY_C
LEFT JOIN HSP_ACCOUNT ha
    ON penc.HSP_ACCOUNT_ID = ha.HSP_ACCOUNT_ID
LEFT JOIN ARPB_TX_COLL_RATIO atcr
    ON arpb.TX_ID = atcr.TX_ID
LEFT JOIN INVOICE inv
    ON ha.HSP_ACCOUNT_ID = inv.PB_HOSP_ACT_ID
LEFT JOIN BDC_INFO bdc
    ON inv.INVOICE_ID = bdc.PB_INVOICE_ID
